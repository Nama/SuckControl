{% extends 'layout.html' %}
{% block content %}
<div class="mdl-grid" id="rules"></div>
<div class="mdl-grid sensors" id="sensors"></div>
<dialog class="mdl-dialog">
    <h4 class="mdl-dialog__title">Rename Sensor</h4>
    <div class="mdl-dialog__content">
<form action="#">
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
        <input class="mdl-textfield__input" type="text" id="newname">
        <label class="mdl-textfield__label" for="newname">New Name</label>
        <p id="ident"></p>
    </div>
</form>
    </div>
    <div class="mdl-dialog__actions">
        <button type="button" class="mdl-button close" onclick="new_name()">Save</button>
        <button type="button" class="mdl-button close_other_button">Cancel</button>
    </div>
</dialog>
<button class="mdl-button mdl-js-button mdl-button--accent mdl-button--fab add_rule" onclick="window.open('/add_rule', '_self')">+</button>
<script>
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    async function run_loop() {
        while (true) {
            if (document.visibilityState === 'visible') {
                await refresh('get_sensors', 'sensors')
                await refresh('get_rules', 'rules')
                await sleep(1000)
            }
            await sleep(100)
        }
    }
    async function rotation() {
        const sensors = document.getElementsByClassName('rpm_icon')
        for (let index = 0; index < sensors.length; ++index) {
            const sensor = sensors[index];
            let control_value = '';
            let nothing = '';
            try {
                control_value = document.getElementById(sensor.id.replace('RPM-', '')).value;
            }
            catch {
                // nVidia GPU I assume...
                control_value = 0;
                nothing = '';
            }
            if (control_value !== '0') {
                const speed = 1000 - ((1000 / 100) * control_value)
                sensor.style.animationDuration = speed + 'ms'
            }
        }
    }
    async function refresh(link, id) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', link, true);
        xhr.onreadystatechange = async function () {
            document.getElementById(id).innerHTML = this.responseText;
            componentHandler.upgradeAllRegistered()  // Needed, so the newly loaded toggles and sliders are decorated
            await rotation();
        };
        xhr.send();

    }
    run_loop()

    function stop_controls() {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/stop_controls', true);
        xhr.send();
    }

    function setSlider(id, value) {
        let data = new FormData();
        data.append('sensorname', id);
        data.append('speed', value);
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/set_controls', true);
        xhr.send(data);
    }

    function delete_rule(id) {
        let data = new FormData();
        data.append('delete', id);
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/delete_rule', true);
        xhr.send(data);
    }

    function toggle_rule(element, id) {
        const state = document.getElementById(element).checked;
        let data = new FormData();
        data.append('enable', state)
        data.append('toggle', id);
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/toggle_rule', true);
        xhr.send(data);
    }

    function rename(id) {
        document.getElementById('newname').value = '';
        document.getElementById('ident').innerText = 'Hardware Identifier: ' + id;
        dialog.showModal();
    }
    function new_name() {
        let data = new FormData();
        data.append('ident', document.getElementById('ident').innerText.replace('Hardware Identifier: ', ''));
        data.append('name', document.getElementById('newname').value);
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/rename_sensor', true);
        xhr.send(data);
        data = null;
    }
    const dialog = document.querySelector('dialog');
    if (!dialog.showModal) {
        dialogPolyfill.registerDialog(dialog);
    }
    dialog.querySelector('.close').addEventListener('click', function () {
        dialog.close();
    });
    dialog.querySelector('.close_other_button').addEventListener('click', function () {
        dialog.close();
    });
    const save_newname = document.getElementById('newname');
    save_newname.addEventListener('keyup', function(event) {
    // Number 13 is the "Enter" key on the keyboard
    if (event.keyCode === 13) {
        // Cancel the default action, if needed
        event.preventDefault();
        new_name();
        dialog.close();
    }
});
</script>
{% endblock %}
